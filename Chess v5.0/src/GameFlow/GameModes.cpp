#include "../../headers/GameFlow/GameModes.h"
#include "raygui.h" 

GameModes::GameModes() {
    DoOnce = true;

    //Default FEN
    FENString = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq";
}

void GameModes::InitialiseMultiplayerMode() {
    if (DoOnce) {
        PlaySound(GameStarts);
        chessboard.initializeBoardFromFEN(FENString, true);
        chessboard.ComputeOpponentMoves();
        DoOnce = false;
        Flags::DisableSinglePlayer();
    }
}

void GameModes::Options() {
    if (IsKeyPressed(KEY_H)) {
        GameStats.toggleHistory();
    }
    if (IsKeyPressed(KEY_R)) RestartGame();
    if (IsKeyPressed(KEY_M)) BackToMenu();
    if (IsKeyPressed(KEY_C)) system("cls");
}

void GameModes::HandleMoves(int PlayerColor) {
    for (int i = 0; i < Total_tiles; i++) {
        if (chessboard.board[i]->color == PlayerColor) {
            chessboard.UpdateChessPiece(chessboard.board[i], i);
        }
    }
}

void GameModes::MultiplayerMode() {
    InitialiseMultiplayerMode();
    if (!GameStats.GameIsEnded(chessboard)) {
        if (chessboard.isCurrentPlayerWhite()) {
            HandleMoves(White);
        }
        else {
            HandleMoves(Black);
        }
        Options();
        if (GameStats.ShowMoveHistory()) GameStats.DrawMoveHistory(chessboard.state.moveHistory);
        else GameStats.DisplayStats(chessboard);
        DisplayBoard();

    }
    else {
        ResetBoard(false);
    }
}

void GameModes::ResetBoard(bool calculateELO) {
    DisplayBoard();

    GameStats.DisplayEndMessage();
    Horizon.state.TerminateSearch();

    if (GameStats.SaveData) {
        if (calculateELO) UpdateElos();
        chessboard.saveCurrentFENtofile("MatchHistory.txt");
        GameStats.SaveData = false;
    }
    if (IsKeyPressed(KEY_R)) RestartGame();
    if (IsKeyPressed(KEY_M)) BackToMenu();
}

void GameModes::RestartGame() {
    Horizon.state.reset();
    DoOnce = true;
    GameStats.Reset();
    chessboard.DestroyBoard();
}

void GameModes::BackToMenu() {
    DoOnce = true;
    GameStats.Reset();
    Horizon.state.reset();
    chessboard.DestroyBoard();
    chessboard.initializeBoardFromFEN(FENString, true);
    Flags::EndGame();
}

void GameModes::UpdateElos() {
    int winner = GameStats.getWinner();
    int oldBlackELO = Horizon.state.getELO();
    Horizon.state.setElO(CalculateELO()(Horizon.state.getELO(), Player.ELO, (winner == Black)));
    Player.ELO = CalculateELO()(Player.ELO, oldBlackELO, (winner == White));
    Settings::save(Horizon.state.getDepth(), Player.ELO, Horizon.state.getELO());

}

void GameModes::InitialiseSinglePlayerMode() {
    if (DoOnce) {
        Horizon.state.setEngineColor(Black);
        Horizon.state.terminateSearch = false;

        Player.setUserName("user");
        PlaySound(GameStarts);
        // chessboard.InitializeDefaultBoard();
		chessboard.initializeBoardFromFEN(FENString, true);

        DoOnce = false;
    }

}

void GameModes::SinglePlayerMode() {
    
    if (!GameStats.GameIsEnded(chessboard)) {
        InitialiseSinglePlayerMode();
        if (chessboard.isCurrentPlayerWhite()) HandleMoves(White);
        else Horizon.state.StartSearch();

        if (GameStats.ShowMoveHistory()) GameStats.DrawMoveHistory(chessboard.state.moveHistory);
        else GameStats.DisplayStats(chessboard, Horizon, Player);
        DisplayBoard();
        GameStats.DrawEvaluationColumn(chessboard);
        Options();
    }
    else ResetBoard(true);
}

void GameModes::DisplayBoard() const {
    graphics.DrawBoard(chessboard);
    graphics.DrawChessPiece(chessboard);
    //chessboard.DrawSquareIndices();
    graphics.DrawCoordinates(chessboard);
}

void GameModes::Destroy() {
    chessboard.DestroyBoard();
}

void GameModes::setFENstring(std::string newFen) {
    FENString = newFen;
}

void GameModes::SaveTranspositions() {
    Horizon.state.SaveTranspositionTable();
}
  
void GameModes::BoardSetUp() {
    chessboard.initializeBoardFromFEN(FENString, true);
    //chessboard.InitializeDefaultBoard();
    //chessboard.initializeBoard();
}

void GameModes::Settings() {
    Rectangle SetDepthBox = { (InfoBoxWidth / 2.0f) - 40.0f, screenHeight / 2.0f - 20.0f, 200.0f, 40.0f };
    GuiTextBox(SetDepthBox, inputDepth, 3, true);
    enteredDepth = atoi(inputDepth);

    GameStats.DisplayNewDepthMessage(enteredDepth);
    if (IsKeyPressed(KEY_ENTER)) {
        Horizon.state.setDepth(enteredDepth);
        Settings::saveElement(Settings::depth, enteredDepth);
        Flags::closeSettings();
    }
}


void GameModes::FENSettings() {
    Rectangle SetFENBox = { (InfoBoxWidth / 2.0f) - 40.0f, screenHeight / 2.0f - 20.0f, 200.0f, 40.0f };
    GuiTextBox(SetFENBox, feninput, sizeof(feninput) - 1, true); // Adjust size for safety

    // Display the current FEN
    GameStats.DisplayNewFENMessage(feninput);

    // Handle paste operation
    if (IsKeyPressed(KEY_V) && IsKeyDown(KEY_LEFT_CONTROL)) {
        const char* clipboardText = GetClipboardText(); // Get text from clipboard
        if (clipboardText != nullptr) {
            // Get the length of the clipboard text
            size_t clipboardLength = strlen(clipboardText);
            // Calculate the space available in feninput
            size_t currentLength = strlen(feninput);
            size_t availableSpace = sizeof(feninput) - currentLength - 1; // -1 for null terminator

            // Only copy as much as fits
            if (availableSpace > 0) {
                // Determine how much to copy
                size_t toCopy = (clipboardLength < availableSpace) ? clipboardLength : availableSpace;
                strncat(feninput, clipboardText, toCopy); // Append clipboard text
            }
        }
    }

    if (IsKeyPressed(KEY_ENTER)) {
        if (feninput[0] != '\0') { // Check if input is not empty
            setFENstring(feninput);
        }
        Flags::closeFENSettings();
    }
}

void GameModes::SetFENStrings(const std::string& fen) {
    FENString = fen;
    chessboard.DestroyBoard();
    chessboard.initializeBoardFromFEN(FENString, true);
}

void GameModes::GameLoop() {
    GameMenu.DrawMenuBox();

    // Check if the game has started
    if (Flags::isGameStarted()) {
        if (Flags::isSinglePlayer()) SinglePlayerMode();
        else if (Flags::isMultiplayerGame()) MultiplayerMode();
    }
    else if (Flags::isFENSettingsOpened()) FENSettings();
    else if (Flags::SettingsOpened()) Settings();
    else {
        if (GameMenu.StartSingleplayer || GameMenu.StartMultiplayer) {
            Flags::StartGame();
            if (GameMenu.StartSingleplayer) Flags::SinglePlayerMode();
            else if (GameMenu.StartMultiplayer) Flags::MultiplayerMode();
        }
        if (GameMenu.OpenSettings) Flags::OpenSettings();
        if (GameMenu.LoadFromFen) Flags::OpenFENSettings();
        DisplayBoard();
        GameMenu.ShowMenu();
    }
}